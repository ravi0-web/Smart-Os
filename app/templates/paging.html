{% extends "base.html" %} 
{% load static %}
{% block title %}ML-Enhanced Page Replacement Predictor{% endblock %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-10">
    <h1 class="text-4xl font-extrabold tracking-tight text-[#010101] mb-8 border-b pb-3 border-gray-200">
        ML-Enhanced Page Replacement Predictor ðŸ§ 
    </h1>

    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mb-6" role="alert">
        <strong class="font-bold">Error!</strong>
        <span class="block sm:inline">{{ error }}</span>
    </div>
    {% endif %}

    {% if message %}<div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-xl relative mb-6">{{ message }}</div>{% endif %}


    <form method="post" id="page-replacement-form" class="grid lg:grid-cols-3 gap-8">
        {% csrf_token %}

        <div class="lg:col-span-1 space-y-6">
            
            <div class="rounded-3xl bg-white p-6 shadow-xl ring-1 ring-gray-100/50 space-y-4">
                <h2 class="text-xl font-semibold text-[#010101] border-b pb-3">Reference Input</h2>
                
                <div class="flex flex-col gap-1">
                    <label for="page_sequence" class="text-sm font-medium text-gray-700">Page Reference Sequence:</label>
                    <input type="text" name="page_sequence" id="page_sequence" required 
                        value="{{ initial_pages|default:'1, 2, 3, 4, 1, 2, 5, 1, 2, 3, 4, 5' }}"
                        placeholder="e.g., 7, 0, 1, 2, 0, 3, 0, 4"
                        class="w-full rounded-xl border border-gray-300 p-2.5 focus:ring-2 focus:ring-[#8a10c5] focus:border-[#8a10c5]/50"/>
                </div>

                <div class="flex flex-col gap-1">
                    <label for="capacity" class="text-sm font-medium text-gray-700">Frame Capacity (M):</label>
                    <input type="number" name="capacity" id="capacity" min="1" required 
                        value="{{ initial_capacity|default:'3' }}"
                        class="w-full rounded-xl border border-gray-300 p-2.5 text-center focus:ring-2 focus:ring-[#8a10c5] focus:border-[#8a10c5]/50"/>
                </div>

                <p class="text-xs text-gray-500 italic">
                    The ML model analyzes the sequence pattern (e.g., randomness, locality) to predict the best algorithm.
                </p>

                <button type="submit" name="generate_random" 
                    class="w-full px-5 py-2.5 rounded-xl bg-gray-100 text-[#010101] hover:bg-gray-200 shadow transition focus:outline-none focus:ring-2 focus:ring-gray-300 border border-gray-300">
                    Generate Random Pattern
                </button>
            </div>
            
            <button type="submit" name="run_simulation" 
                class="w-full px-5 py-3 rounded-2xl bg-[#8a10c5] text-white font-bold text-lg hover:opacity-90 shadow-lg shadow-[#8a10c5]/50 transition focus:outline-none focus:ring-4 focus:ring-[#8a10c5]/40">
                Run Simulation & Get ML Suggestion
            </button>
        </div>

        <div class="lg:col-span-2">
            {% if results %}
            <div class="results-container rounded-3xl p-0 shadow-2xl bg-white border border-gray-200">
                
                <div class="flex border-b border-gray-200">
                    <button type="button" class="tab-button-pr px-4 py-3 text-sm font-medium transition duration-150 ease-in-out" 
                            data-tab="metrics-pr" aria-selected="true">
                        Metrics & Recommendation
                    </button>
                    <button type="button" class="tab-button-pr px-4 py-3 text-sm font-medium transition duration-150 ease-in-out" 
                            data-tab="chart-pr" aria-selected="false">
                        Faults Comparison Chart
                    </button>
                </div>

                <div id="tab-metrics-pr" class="tab-content-pr p-6 space-y-6">
                    <h2 class="text-2xl font-bold text-[#003366] mb-4">ML-Based Recommendation</h2>
                    
                    <div class="p-5 border-l-4 border-[#8a10c5] rounded-lg shadow-md bg-[#f7f3ff]">
                        <p class="text-lg font-extrabold text-[#8a10c5] mb-2">
                            STABLE RECOMMENDATION
                        </p>
                        <p class="text-gray-800">
                            Based on ML predictions, <strong class="text-[#8a10c5]">{{ results.ml_policy }}</strong> is the optimal algorithm for this workload, with <strong class="text-[#8a10c5]">{{ results.ml_confidence }}%</strong> confidence.
                        </p>
                        <p class="text-xs text-gray-600 mt-2 italic">
                            Reasoning: {{ results.reason }}
                        </p>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 pt-4">--- PERFORMANCE METRICS ---</h3>

                    <div class="grid grid-cols-3 gap-4">
                        {% for policy, faults in results.faults.items %}
                        <div class="p-4 rounded-lg shadow-sm border 
                            {% if policy == results.ml_policy %} 
                                bg-green-50 border-green-400 text-green-700 
                            {% elif policy == 'OPTIMAL' %}
                                bg-blue-50 border-blue-400 text-blue-700
                            {% else %}
                                bg-yellow-50 border-yellow-400 text-yellow-700
                            {% endif %}">
                            <p class="text-sm font-bold">{{ policy }} Faults:</p>
                            <p class="text-xl font-extrabold">{{ faults }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 pt-4">--- INPUT DETAILS ---</h3>
                    <p class="text-gray-700"><strong>Sequence:</strong> <code class="bg-gray-100 p-1 rounded text-sm">{{ results.input_sequence }}</code></p>
                    <p class="text-gray-700"><strong>Capacity:</strong> <span class="font-bold">{{ results.capacity }}</span> Frames</p>

                </div>
                
                <div id="tab-chart-pr" class="tab-content-pr p-6 space-y-6" style="display: none;">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Page Faults Comparison Chart</h3>
                    
                    {% if results.chart_base64 %}
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                        <img src="data:image/png;base64,{{ results.chart_base64 }}" alt="Page Faults Comparison Plot" class="w-full h-auto">
                    </div>
                    <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                        <p class="text-sm text-blue-800">
                            This chart visually compares the actual number of page faults generated by the three standard policies (FIFO, LRU, OPTIMAL) for the given reference string.
                        </p>
                    </div>
                    {% else %}
                    <p class="text-gray-500">Faults Comparison chart will appear here after running the simulation.</p>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="lg:col-span-2 rounded-3xl bg-white p-10 shadow-xl ring-1 ring-gray-100/50 text-center border-dashed border-2 border-gray-300 h-full flex items-center justify-center">
                <p class="text-gray-500 font-medium text-lg">
                    Input your reference sequence and frame count on the left and click **'Run Simulation & Get ML Suggestion'** to see the comparison, chart, and ML-based recommendation here.
                </p>
            </div>
            {% endif %}
        </div>
    </form>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- TAB MANAGEMENT FUNCTIONALITY (Page Replacement specific) ---
        function showTabPR(tabId) {
            // 1. Hide all tab contents
            document.querySelectorAll('.tab-content-pr').forEach(content => {
                content.style.display = 'none';
            });

            // 2. Deactivate all buttons
            document.querySelectorAll('.tab-button-pr').forEach(button => {
                button.classList.remove('bg-white', 'text-[#010101]', 'border-t', 'border-x');
                button.classList.add('bg-gray-100', 'text-gray-600', 'border-b');
                button.removeAttribute('aria-selected');
            });

            // 3. Show the requested content
            const contentToShow = document.getElementById(`tab-${tabId}`);
            if (contentToShow) {
                contentToShow.style.display = 'block';
            }

            // 4. Activate the corresponding button
            const activeBtn = document.querySelector(`.tab-button-pr[data-tab="${tabId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-white', 'text-[#010101]', 'border-t', 'border-x', 'border-white');
                activeBtn.classList.remove('bg-gray-100', 'text-gray-600', 'border-b');
                activeBtn.setAttribute('aria-selected', 'true');
            }
        }

        // Attach click listeners to tab buttons
        document.querySelectorAll('.tab-button-pr').forEach(button => {
            button.addEventListener('click', function() {
                showTabPR(this.getAttribute('data-tab'));
            });
        });
        
        // Show the initial tab (Metrics) on load
        showTabPR('metrics-pr');
        
        // --- Input Persistence for POST requests ---
        // This is a minimal implementation, proper persistence would be handled by Django's template engine
        const form = document.getElementById('page-replacement-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // If not running simulation, don't validate, just let it pass (for random generator)
                if (e.submitter && e.submitter.name === 'generate_random') {
                    return; 
                }
                
                const seq = document.getElementById('page_sequence').value.trim();
                const cap = document.getElementById('capacity').value.trim();
                
                if (seq === "" || cap === "" || parseInt(cap) <= 0) {
                    alert("Please provide a valid page sequence and a positive frame capacity.");
                    e.preventDefault();
                }
            });
        }
    });
</script>
{% endblock %}