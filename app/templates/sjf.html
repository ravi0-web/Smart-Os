{% extends "base.html" %}
{% load custom_filters %}
{% block title %}ML-Predictive SJF Burst Time Prediction{% endblock %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-10">
    <h1 class="text-4xl font-extrabold tracking-tight text-[#010101] mb-8 border-b pb-3 border-gray-200">
        SJF Burst Time Prediction (ML) üß†
    </h1>

    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mb-6" role="alert">
        <strong class="font-bold">Error!</strong>
        <span class="block sm:inline">{{ error }}</span>
    </div>
    {% endif %}

    <form method="post" id="sjf-predictor-form" class="grid lg:grid-cols-3 gap-8">
        {% csrf_token %}

        <div class="lg:col-span-1 space-y-6">
            
            <div class="rounded-3xl bg-white p-6 shadow-xl ring-1 ring-gray-100/50 space-y-4">
                <h2 class="text-xl font-semibold text-[#010101] border-b pb-3">Prediction Configuration</h2>
                
                <div class="flex flex-col gap-1">
                    <label for="num_processes_sjf" class="text-sm font-medium text-gray-700">Number of Processes:</label>
                    <input type="number" name="num_processes" id="num_processes_sjf" min="1" max="10" value="{% if submitted_data_sjf %}{{ submitted_data_sjf.num_processes|default:'3' }}{% else %}3{% endif %}"
                        class="w-full rounded-xl border border-gray-300 p-2.5 text-center focus:ring-2 focus:ring-[#8a10c5] focus:border-[#8a10c5]/50" required/>
                </div>

                <p class="text-xs text-gray-500 italic">
                    The ML model predicts the **true Burst Time** based primarily on the **Arrival Time**, which is used as a proxy for potential CPU load, to determine the optimal SJF schedule.
                </p>

                <button type="button" onclick="window.generateTableManualSJF()" 
                    class="w-full px-5 py-2.5 rounded-xl bg-gray-100 text-[#010101] hover:bg-gray-200 shadow transition focus:outline-none focus:ring-2 focus:ring-gray-300 border border-gray-300">
                    Generate/Update Table
                </button>
            </div>

            <div class="rounded-3xl bg-white p-6 shadow-xl ring-1 ring-gray-100/50 space-y-4">
                <h2 class="text-xl font-semibold text-[#010101] border-b pb-3">Process Inputs for Prediction</h2>
                <div id="process_details_sjf">
                    <p class="text-gray-500" id="table-placeholder-sjf">Click 'Generate/Update Table' to input process details.</p>
                </div>
            </div>

            <button type="submit" 
                class="w-full px-5 py-3 rounded-2xl bg-[#8a10c5] text-white font-bold text-lg hover:opacity-90 shadow-lg shadow-[#8a10c5]/50 transition focus:outline-none focus:ring-4 focus:ring-[#8a10c5]/40">
                Run SJF Prediction & Simulation
            </button>
        </div>

        <div class="lg:col-span-2">
            {% if sjf_results %}
            <div class="results-container rounded-3xl p-0 shadow-2xl bg-white border border-gray-200">
                
                <div class="flex border-b border-gray-200">
                    <button type="button" class="tab-button-sjf px-4 py-3 text-sm font-medium transition duration-150 ease-in-out" 
                            data-tab="metrics-sjf" aria-selected="true">
                        Metrics & Tables
                    </button>
                    <button type="button" class="tab-button-sjf px-4 py-3 text-sm font-medium transition duration-150 ease-in-out" 
                            data-tab="burst-comp-sjf" aria-selected="false">
                        1. Burst Prediction Comparison
                    </button>
                    <button type="button" class="tab-button-sjf px-4 py-3 text-sm font-medium transition duration-150 ease-in-out" 
                            data-tab="burst-arrival-sjf" aria-selected="false">
                        2. Actual Burst vs. Arrival
                    </button>
                    <button type="button" class="tab-button-sjf px-4 py-3 text-sm font-medium transition duration-150 ease-in-out" 
                            data-tab="gantt-sjf" aria-selected="false">
                        3. Gantt Chart
                    </button>
                </div>

                <div id="tab-metrics-sjf" class="tab-content-sjf p-6 space-y-6">
                    <h2 class="text-2xl font-bold text-[#003366] mb-4">ML Predicted SJF Results</h2>
                    
                    <div class="bg-blue-50 p-4 border-l-4 border-blue-500 rounded-lg shadow-md">
                        <p class="text-lg font-extrabold text-blue-700">
                            SJF Simulation Metrics (Using ML Predicted Burst Times)
                        </p>
                        <p class="mt-2 text-gray-800">
                            Average Turnaround Time: <strong class="text-[#8a10c5]">{{ sjf_results.avg_turnaround|floatformat:"2" }} ms</strong>
                        </p>
                        <p class="text-gray-800">
                            Average Waiting Time: <strong class="text-[#8a10c5]">{{ sjf_results.avg_waiting|floatformat:"2" }} ms</strong>
                        </p>
                    </div>

                    {% if initial_predictions %}
                    <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 pt-4">=== BURST PREDICTION COMPARISON (Arrival-Dependent) ===</h3>
                    <p class="text-xs text-gray-500 italic mb-2">
                        <span class="font-bold">Prediction Explanation:</span> 1Ô∏è‚É£ Simple Avg, 2Ô∏è‚É£ Exponential Avg, 3Ô∏è‚É£ ML Pred (used for scheduling)
                    </p>
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-sm text-left text-gray-700 shadow-md sm:rounded-lg">
                            <thead class="text-xs text-white uppercase bg-gray-600">
                                <tr>
                                    <th scope="col" class="py-3 px-3 text-center">PID</th>
                                    <th scope="col" class="py-3 px-3 text-center">Arrival</th>
                                    <th scope="col" class="py-3 px-3 text-center">CPU_Load</th>
                                    <th scope="col" class="py-3 px-3 text-center">Actual_Burst</th>
                                    <th scope="col" class="py-3 px-3 text-center">Simple_Avg</th>
                                    <th scope="col" class="py-3 px-3 text-center">Exp_Avg</th>
                                    <th scope="col" class="py-3 px-3 text-center">ML_Pred</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for process in initial_predictions %}
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td class="py-3 px-3 font-medium text-center text-gray-900 whitespace-nowrap">{{ process.PID }}</td>
                                    <td class="py-3 px-3 text-center">{{ process.Arrival|floatformat:"2" }}</td>
                                    <td class="py-3 px-3 text-center">{{ process.CPU_Load|floatformat:"2" }}</td>
                                    <td class="py-3 px-3 text-center">{{ process.Actual_Burst|floatformat:"2" }}</td>
                                    <td class="py-3 px-3 text-center">{{ process.Simple_Avg|floatformat:"2" }}</td>
                                    <td class="py-3 px-3 text-center">{{ process.Exp_Avg|floatformat:"2" }}</td>
                                    <td class="py-3 px-3 text-center font-bold text-[#8a10c5]">{{ process.ML_Pred|floatformat:"2" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    {% if sjf_results and sjf_results.schedule %}
                    <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 pt-4">=== FINAL SJF SCHEDULING (Using ML_Pred) ===</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-700 shadow-md sm:rounded-lg">
                            <thead class="text-xs text-white uppercase bg-[#003366]">
                                <tr>
                                    <th scope="col" class="py-3 px-6">PID</th>
                                    <th scope="col" class="py-3 px-6">Arrival</th>
                                    <th scope="col" class="py-3 px-6">ML_Pred</th>
                                    <th scope="col" class="py-3 px-6">Completion</th>
                                    <th scope="col" class="py-3 px-6">Turnaround</th>
                                    <th scope="col" class="py-3 px-6">Waiting</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for process in sjf_results.schedule %}
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td class="py-3 px-6 font-medium text-gray-900 whitespace-nowrap">{{ process.PID }}</td>
                                    <td class="py-3 px-6">{{ process.Arrival|floatformat:"2" }}</td>
                                    <td class="py-3 px-6 font-bold">{{ process.ML_Pred|floatformat:"2" }}</td>
                                    <td class="py-3 px-6">{{ process.Completion|floatformat:"2" }}</td>
                                    <td class="py-3 px-6">{{ process.Turnaround|floatformat:"2" }}</td>
                                    <td class="py-3 px-6">{{ process.Waiting|floatformat:"2" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                
                <div id="tab-burst-comp-sjf" class="tab-content-sjf p-6 space-y-6" style="display: none;">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">1. Burst Prediction Comparison Plot</h3>
                    
                    {% if burst_comparison_base64 %}
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                        <img src="data:image/png;base64,{{ burst_comparison_base64 }}" alt="Burst Prediction Comparison Plot" class="w-full h-auto">
                    </div>
                    <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                        <p class="text-sm text-blue-800">
                            This chart compares the **Actual Burst Time** against the predicted values from Simple Averaging, Exponential Averaging, and the ML Model for each process. The ML prediction should be the closest to the Actual Burst.
                        </p>
                    </div>
                    {% else %}
                    <p class="text-gray-500">Burst Prediction Comparison chart will appear here after running the simulation.</p>
                    {% endif %}
                </div>

                <div id="tab-burst-arrival-sjf" class="tab-content-sjf p-6 space-y-6" style="display: none;">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">2. Actual Burst vs. Arrival Time</h3>
                    
                    {% if burst_arrival_base64 %}
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                        <img src="data:image/png;base64,{{ burst_arrival_base64 }}" alt="Actual Burst vs. Arrival Plot" class="w-full h-auto">
                    </div>
                    <div class="mt-4 p-4 bg-green-50 border-l-4 border-green-500 rounded-lg">
                        <p class="text-sm text-green-800">
                            This chart visualizes the input parameters for the ML model, showing the relationship between a process's **Arrival Time** and its true **Actual Burst Time**. This helps illustrate the non-linear correlation the ML model is trying to learn.
                        </p>
                    </div>
                    {% else %}
                    <p class="text-gray-500">Actual Burst vs. Arrival Time chart will appear here after running the simulation.</p>
                    {% endif %}
                </div>

                <div id="tab-gantt-sjf" class="tab-content-sjf p-6 space-y-6" style="display: none;">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">3. SJF Gantt Chart (ML Prediction)</h3>
                    
                    {% if gantt_base64_sjf %}
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                        <img src="data:image/png;base64,{{ gantt_base64_sjf }}" alt="SJF ML Gantt Chart" class="w-full h-auto">
                    </div>
                    {% else %}
                    <p class="text-gray-500">Gantt chart will appear here after running the prediction.</p>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="lg:col-span-2 rounded-3xl bg-white p-10 shadow-xl ring-1 ring-gray-100/50 text-center border-dashed border-2 border-gray-300 h-full flex items-center justify-center">
                <p class="text-gray-500 font-medium text-lg">
                    Enter the process details on the left (only Arrival Time is needed) and click **'Run SJF Prediction & Simulation'** to view the schedule, tables, and **three focused charts**.
                </p>
            </div>
            {% endif %}
        </div>
    </form>
</section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // CRUCIAL: Get data passed back from the Django view after a POST request.
    const submittedDataSJF = JSON.parse('{{ submitted_data_sjf|safe|default:"{}" }}');
    const isPostBackSJF = Object.keys(submittedDataSJF).length > 0;
    
    // --- TAB MANAGEMENT FUNCTIONALITY (SJF specific) ---
    function showTabSJF(tabId) {
        // 1. Hide all tab contents
        document.querySelectorAll('.tab-content-sjf').forEach(content => {
            content.style.display = 'none';
        });

        // 2. Deactivate all buttons
        document.querySelectorAll('.tab-button-sjf').forEach(button => {
            button.classList.remove('bg-white', 'text-[#010101]', 'border-t', 'border-x');
            button.classList.add('bg-gray-100', 'text-gray-600', 'border-b');
            button.removeAttribute('aria-selected');
        });

        // 3. Show the requested content
        const contentToShow = document.getElementById(`tab-${tabId}`);
        if (contentToShow) {
            contentToShow.style.display = 'block';
        }

        // 4. Activate the corresponding button
        const activeBtn = document.querySelector(`.tab-button-sjf[data-tab="${tabId}"]`);
        if (activeBtn) {
            activeBtn.classList.add('bg-white', 'text-[#010101]', 'border-t', 'border-x', 'border-white');
            activeBtn.classList.remove('bg-gray-100', 'text-gray-600', 'border-b');
            activeBtn.setAttribute('aria-selected', 'true');
        }
    }

    // Attach click listeners to tab buttons
    $(document).ready(function() {
        document.querySelectorAll('.tab-button-sjf').forEach(button => {
            button.addEventListener('click', function() {
                showTabSJF(this.getAttribute('data-tab'));
            });
        });
    });
    // ------------------------------------
    
    /**
     * Dynamically generates the process input table for SJF prediction.
     * Only includes 'Arrival Time (A)'.
     */
    function generateTableSJF(prefillData = null) {
        const numProcesses = parseInt($('#num_processes_sjf').val());
        const $details = $('#process_details_sjf');
        
        if (isNaN(numProcesses) || numProcesses < 1 || numProcesses > 10) {
            alert("Please enter a number between 1 and 10.");
            return;
        }

        let headers = ["Process ID", "Arrival Time (A)"]; 
        
        let tableHtml = `<div class="overflow-x-auto"><table class="table-input w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    ${headers.map(h => `<th class="py-2 px-3 font-medium text-gray-600 text-center">${h}</th>`).join('')}
                </tr>
            </thead>
            <tbody>`;

        for (let i = 1; i <= numProcesses; i++) {
            const arrivalValue = prefillData ? (prefillData[`P${i}_arrival`] || "") : "";
            
            tableHtml += `<tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-2 px-3 font-medium text-center">P${i}</td>
                <td class="py-2 px-3 flex justify-center"><input type="number" name="P${i}_arrival" value="${arrivalValue}" placeholder="e.g., 0" min="0" step="0.01" required 
                    class="w-full text-center border rounded-md p-1 focus:ring-2 focus:ring-[#8a10c5] focus:border-[#8a10c5]/50 text-sm" style="max-width: 80px;"></td>
                </tr>`; 
        }
        
        tableHtml += `</tbody></table></div>`;
        $details.html(tableHtml);
    }
    
    window.generateTableManualSJF = function() {
        generateTableSJF(null);
    };


    // Event Handler: Window Load (initial setup and post-back restore)
    $(document).ready(function() {
        if (isPostBackSJF) {
            const numProcesses = submittedDataSJF['num_processes'][0] || '3';
            $('#num_processes_sjf').val(numProcesses);
            
            let repopulationData = {};
            for (const key in submittedDataSJF) {
                if (submittedDataSJF.hasOwnProperty(key)) {
                    repopulationData[key] = submittedDataSJF[key][0];
                }
            }
            generateTableSJF(repopulationData);
            
            // Default to metrics tab
            showTabSJF('metrics-sjf');
        } else {
            showTabSJF('metrics-sjf');
        }
    });

    // Client-Side Validation to require table generation before submission
    $('#sjf-predictor-form').on('submit', function(e) {
        if ($('#process_details_sjf').find('#table-placeholder-sjf').length > 0) {
            alert('üõë Please click "Generate/Update Table" to input your process details before running the simulation.');
            e.preventDefault();
        }
    });
</script>
{% endblock %}